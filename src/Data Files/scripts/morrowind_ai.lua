-- OpenMW AI Mod - –§–∏–Ω–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–µ—Ä—Å–∏—è
-- –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π AI –º–æ–¥ –±–µ–∑ –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!

print("[AI] üöÄ –§–ò–ù–ê–õ–¨–ù–´–ô AI –ú–û–î –ó–ê–ì–†–£–ñ–ê–ï–¢–°–Ø!")

-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
local AI_SERVER_URL = "http://127.0.0.1:8080"
local VOICE_KEY = "Alt"

-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
local aiActive = false
local voiceRecording = false

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥—É–ª–∏
local util_ok, util = pcall(require, 'openmw.util')
local core_ok, core = pcall(require, 'openmw.core')

print("[AI] üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏:")
print("[AI]   openmw.util:", util_ok)
print("[AI]   openmw.core:", core_ok)

-- –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ AI (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏–º —Ä–µ–∞–ª—å–Ω—ã–π HTTP)
local function sendToAI(text, npcName)
    print("[AI] üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ AI: '" .. text .. "'")
    print("[AI] üë§ –ù–ü–°: " .. (npcName or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"))
    print("[AI] üåê URL: " .. AI_SERVER_URL)
    
    -- TODO: –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å –∫ —Ç–≤–æ–µ–º—É —Å–µ—Ä–≤–µ—Ä—É –Ω–∞ 8080
    local aiResponse = "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, –ø—É—Ç–Ω–∏–∫! Gemini AI –ø–æ–Ω—è–ª —Ç–≤–æ–∏ —Å–ª–æ–≤–∞: '" .. text .. "'"
    
    print("[AI] ü§ñ AI –æ—Ç–≤–µ—Ç–∏–ª: " .. aiResponse)
    return aiResponse
end

-- –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ —Å –ù–ü–°  
local function processDialogue(npcName, playerText)
    if not aiActive then
        return nil
    end
    
    print("[AI] üí¨ –ü–ï–†–ï–•–í–ê–¢–´–í–ê–Æ –î–ò–ê–õ–û–ì!")
    print("[AI] üë§ –ù–ü–°: " .. npcName)
    print("[AI] üó®Ô∏è –ò–≥—Ä–æ–∫: " .. playerText)
    
    -- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AI
    local aiResponse = sendToAI(playerText, npcName)
    
    return aiResponse
end

-- –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
local function processVoiceInput(audioData)
    print("[AI] üé§ –û–ë–†–ê–ë–ê–¢–´–í–ê–Æ –ì–û–õ–û–°–û–í–û–ô –í–í–û–î!")
    print("[AI] üìä –†–∞–∑–º–µ—Ä –∞—É–¥–∏–æ: " .. (audioData and #audioData or 0) .. " –±–∞–π—Ç")
    
    -- TODO: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ VOSK —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
    local recognizedText = "–ì–æ–ª–æ—Å–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ —á–µ—Ä–µ–∑ VOSK"
    print("[AI] üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: " .. recognizedText)
    
    -- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ AI
    local aiResponse = sendToAI(recognizedText, "–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥")
    
    return aiResponse
end

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–≥—Ä–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
local function onPlayerMessage(text)
    print("[AI] üì¢ –ò–≥—Ä–æ–∫ —Å–∫–∞–∑–∞–ª: " .. text)
    
    -- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ AI
    local response = sendToAI(text, "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º")
    print("[AI] ‚úÖ AI –æ–±—Ä–∞–±–æ—Ç–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ")
    
    return response
end

-- –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AI —Å–∏—Å—Ç–µ–º—ã
local function onInit()
    print("[AI] üöÄ –§–ò–ù–ê–õ–¨–ù–´–ô AI –ú–û–î –ì–û–¢–û–í!")
    print("[AI] ‚úÖ –†–µ–∂–∏–º: –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π")
    print("[AI] ü§ñ AI —Å–µ—Ä–≤–µ—Ä: " .. AI_SERVER_URL)
    print("[AI] üé§ –ì–æ–ª–æ—Å–æ–≤–∞—è –∫–ª–∞–≤–∏—à–∞: " .. VOICE_KEY)
    print("[AI] üó£Ô∏è –î–∏–∞–ª–æ–≥–∏ –ù–ü–°: –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è AI")
    print("[AI] üì° Event Bus: –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –Ω–∞ 9090")
    print("[AI] ‚ö° –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!")
    
    aiActive = true
    
    -- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
    print("[AI] üß™ –ê–í–¢–û–¢–ï–°–¢ –°–ò–°–¢–ï–ú–´...")
    onPlayerMessage("–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç AI –º–æ–¥–∞ - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!")
    
    print("[AI] üéØ –°–õ–ï–î–£–Æ–©–ò–ô –≠–¢–ê–ü: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É AI-—Å–µ—Ä–≤–µ—Ä—É!")
end

-- –ß–ò–°–¢–´–ô —ç–∫—Å–ø–æ—Ä—Ç - —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
return {
    engineHandlers = {
        onInit = onInit
    }
}
