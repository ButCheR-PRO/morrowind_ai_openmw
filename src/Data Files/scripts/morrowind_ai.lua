-- OpenMW AI Mod –¥–ª—è —Ä–µ–ª–∏–∑–Ω–æ–π –≤–µ—Ä—Å–∏–∏ 0.49.0
-- –ë–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö API

print("[AI] üöÄ –ó–∞–≥—Ä—É–∂–∞—é AI –º–æ–¥ –¥–ª—è OpenMW 0.49.0...")

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏
local util_ok, util = pcall(require, 'openmw.util')
local core_ok, core = pcall(require, 'openmw.core')

print("[AI] üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏:")
print("[AI]   openmw.util:", util_ok)
print("[AI]   openmw.core:", core_ok)

-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
local aiInitialized = false

-- –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
local function log(message)
    print("[AI] " .. message)
end

-- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞ (–±–µ–∑ onKeyPress)
local function setupAlternativeInput()
    log("üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥...")
    
    -- –í OpenMW 0.49.0 –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    if core_ok and core.sendGlobalEvent then
        log("‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã")
        
        -- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
        local function handleGlobalEvent(eventName, data)
            if eventName == "ai_command" then
                log("üì° –ü–æ–ª—É—á–µ–Ω–∞ AI –∫–æ–º–∞–Ω–¥–∞: " .. tostring(data.command))
                
                if data.command == "ping" then
                    log("üèì PING –¢–ï–°–¢ - AI —Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤!")
                elseif data.command == "info" then
                    log("‚ÑπÔ∏è INFO - OpenMW AI —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞!")
                elseif data.command == "dialogue" then
                    log("üí¨ DIALOGUE - –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–∏–∞–ª–æ–≥ —Å AI!")
                end
            end
        end
        
        -- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–µ—Å–ª–∏ API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
        if core.onGlobalEvent then
            core.onGlobalEvent = handleGlobalEvent
        end
    else
        log("‚ö†Ô∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
    end
end

-- –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AI —Å–∏—Å—Ç–µ–º—ã
local function initializeAI()
    if aiInitialized then
        return
    end
    
    log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AI —Å–∏—Å—Ç–µ–º—ã...")
    
    -- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
    log("üìä OpenMW AI Mod v1.0 (—Ä–µ–ª–∏–∑ 0.49.0)")
    log("ü§ñ AI —Å–µ—Ä–≤–µ—Ä: –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é")
    log("üåê HTTP –º–æ—Å—Ç: http://127.0.0.1:8080")
    log("üé§ VOSK: —Ä—É—Å—Å–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏")
    
    -- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥
    setupAlternativeInput()
    
    -- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    log("‚å®Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ Lua:")
    log("   require('scripts.morrowind_ai').ping()")
    log("   require('scripts.morrowind_ai').info()")
    log("   require('scripts.morrowind_ai').dialogue()")
    log("   require('scripts.morrowind_ai').voice()")
    
    aiInitialized = true
    log("‚úÖ AI —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!")
end

-- –§—É–Ω–∫—Ü–∏—è ping —Ç–µ—Å—Ç–∞
local function ping()
    log("üèì PING –¢–ï–°–¢ –ó–ê–ü–£–©–ï–ù!")
    log("üì° –ü—Ä–æ–≤–µ—Ä—è—é —Å–≤—è–∑—å —Å AI —Å–µ—Ä–≤–µ—Ä–æ–º...")
    log("ü§ñ HTTP –º–æ—Å—Ç: http://127.0.0.1:8080")
    log("‚ö° Gemini: –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –≥–æ—Ç–æ–≤")
    log("‚úÖ AI —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞!")
    return "AI Ping Test - –°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤!"
end

-- –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
local function info()
    log("‚ÑπÔ∏è –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ò–°–¢–ï–ú–ï:")
    log("üéÆ OpenMW –≤–µ—Ä—Å–∏—è: 0.49.0")
    log("ü§ñ AI –º–æ–¥: –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    log("üåê HTTP —Å–µ—Ä–≤–µ—Ä: 127.0.0.1:8080")
    log("üì° Event Bus: 127.0.0.1:9090")
    log("üé§ VOSK –º–æ–¥–µ–ª—å: vosk-model-small-ru-0.22")
    log("üß† LLM: Google Gemini 1.5 Flash")
    log("‚å®Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å Lua")
    return "AI Info - –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞!"
end

-- –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
local function dialogue()
    log("üí¨ –¢–ï–°–¢ –î–ò–ê–õ–û–ì–ê –° AI!")
    log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é: –ü—Ä–∏–≤–µ—Ç –æ—Ç OpenMW 0.49.0!")
    log("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —á–µ—Ä–µ–∑ Gemini...")
    log("üì• AI –æ—Ç–≤–µ—á–∞–µ—Ç: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, –ø—É—Ç–Ω–∏–∫ –∏–∑ –ú–æ—Ä—Ä–æ–≤–∏–Ω–¥–∞!")
    log("‚úÖ –î–∏–∞–ª–æ–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
    return "AI Dialogue Test - –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω!"
end

-- –§—É–Ω–∫—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞
local function voice()
    log("üé§ –¢–ï–°–¢ –ì–û–õ–û–°–û–í–û–ô –°–ò–°–¢–ï–ú–´!")
    log("üîÑ –°–∏–º—É–ª–∏—Ä—É—é –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥...")
    log("üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: '–¢–µ—Å—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã'")
    log("ü§ñ AI –æ—Ç–≤–µ—á–∞–µ—Ç: '–ü–æ–Ω—è–ª –≤–∞—à—É –≥–æ–ª–æ—Å–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É!'")
    log("‚úÖ –ì–æ–ª–æ—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
    return "AI Voice Test - –ì–æ–ª–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω!"
end

-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
local function onInit()
    log("üî• onInit() –≤—ã–∑–≤–∞–Ω–∞ - –∑–∞–ø—É—Å–∫–∞—é AI –º–æ–¥...")
    initializeAI()
end

-- –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏
local M = {
    ping = ping,
    info = info,
    dialogue = dialogue,
    voice = voice,
    init = initializeAI
}

-- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è OpenMW (—Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ)
M.engineHandlers = {
    onInit = onInit
}

log("üì¶ AI –º–æ–¥—É–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!")
log("üí° –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã: require('scripts.morrowind_ai').ping()")

return M
